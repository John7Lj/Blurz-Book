
i want to change the current client side of blurz bool to looks simmilar to the routine app  ::



routine  app some pages ::





import React, { useState, useEffect } from 'react';
import { Plus, BarChart3, User, Moon, Sun, History, Menu, X } from 'lucide-react';
import RoutineList from './RoutineList';
import AddRoutineForm from './AddRoutineForm';
import ReportsView from './ReportsView';
import ProfileSettings from './ProfileSettings';
import HistoryView from './HistoryView';
import * as api from '../api';

// Modern Loading Spinner Component
function LoadingSpinner({ darkMode }) {
  return (
    <div className="text-center">
      <div className="inline-block w-10 h-10 border-[2.5px] border-gray-200 border-t-[#0088cc] rounded-full animate-spin" style={{animationDuration: '0.5s'}}></div>
    </div>
  );
}

export default function Dashboard({ user, onLogout, settings, setSettings }) {
  // Get initial view from URL or default to 'routines'
  const getInitialView = () => {
    const params = new URLSearchParams(window.location.search);
    return params.get('view') || 'routines';
  };

  const [currentView, setCurrentView] = useState(getInitialView());
  const [showAddRoutine, setShowAddRoutine] = useState(false);
  const [routines, setRoutines] = useState([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState(null);
  const [sidebarOpen, setSidebarOpen] = useState(false);

  const bgClass = settings.darkMode ? 'bg-gray-900' : 'bg-gray-50';
  const cardClass = settings.darkMode ? 'bg-gray-800' : 'bg-white';
  const textClass = settings.darkMode ? 'text-white' : 'text-gray-900';
  const borderClass = settings.darkMode ? 'border-gray-700' : 'border-gray-200';

  // Update URL when view changes
  useEffect(() => {
    const params = new URLSearchParams(window.location.search);
    params.set('view', currentView);
    window.history.replaceState({}, '', `${window.location.pathname}?${params}`);
  }, [currentView]);

  // Load routines on mount
  useEffect(() => {
    loadRoutines();
  }, []);

  const loadRoutines = async () => {
    try {
      setLoading(true);
      setError(null);
      const data = await api.getRoutines();
      
      // Load checks for each routine
      const routinesWithChecks = await Promise.all(
        data.map(async (routine) => {
          try {
            const checks = await api.getChecks(routine.id);
            return {
              ...routine,
              dailyChecks: checks.map(c => ({
                date: c.date,
                values: c.values,
                checkedAt: c.checked_at
              }))
            };
          } catch (err) {
            console.error(`Error loading checks for routine ${routine.id}:`, err);
            return {
              ...routine,
              dailyChecks: []
            };
          }
        })
      );
      
      setRoutines(routinesWithChecks);
    } catch (err) {
      console.error('Error loading routines:', err);
      setError('Failed to load routines');
    } finally {
      setLoading(false);
    }
  };

  const addRoutine = async (routineData) => {
    try {
      const newRoutine = await api.createRoutine(routineData);
      setRoutines([...routines, {
        ...newRoutine,
        dailyChecks: []
      }]);
      setShowAddRoutine(false);
    } catch (err) {
      console.error('Error creating routine:', err);
      alert('Failed to create routine: ' + err.message);
    }
  };

  const deleteRoutine = async (routineId) => {
    if (!confirm('Are you sure you want to delete this routine?')) return;
    
    try {
      await api.deleteRoutine(routineId);
      setRoutines(routines.filter(r => r.id !== routineId));
    } catch (err) {
      console.error('Error deleting routine:', err);
      alert('Failed to delete routine: ' + err.message);
    }
  };

  const updateRoutineChecks = async (routineId, newCheck) => {
    try {
      await api.submitCheck(newCheck);
      // Reload routines to get updated checks
      await loadRoutines();
    } catch (err) {
      console.error('Error submitting check:', err);
      alert('Failed to submit check: ' + err.message);
    }
  };

  const navItems = [
    { id: 'routines', label: 'Routines', icon: Plus },
    { id: 'history', label: 'History', icon: History },
    { id: 'reports', label: 'Reports', icon: BarChart3 },
    { id: 'profile', label: 'Profile', icon: User },
  ];

  if (loading) {
    return (
      <div className={`min-h-screen ${bgClass} flex items-center justify-center`}>
        <div className="text-center">
          <LoadingSpinner darkMode={settings.darkMode} />
          <p className={`mt-4 ${textClass} text-sm`}>Loading routines...</p>
        </div>
      </div>
    );
  }

  return (
    <div className={`min-h-screen ${bgClass} transition-colors`} style={{ fontFamily: settings.fontFamily }}>
      {/* Mobile Header */}
      <div className={`${cardClass} border-b ${borderClass} sticky top-0 z-40 shadow-sm`}>
        <div className="flex items-center justify-between p-4">
          <div className="flex items-center gap-0">
            <img 
              src="/logo.png" 
              alt="Blurz17 Logo" 
              className="w-20 h-22 "
            />
            <h1 className={`text-xl sm:text-1xl font-bold -ml-1 ${textClass}`}>Blurz17</h1>
          </div>
          
          <div className="flex items-center gap-2">
            <button
              onClick={() => setSettings({ ...settings, darkMode: !settings.darkMode })}
              className={`p-2 rounded-lg ${settings.darkMode ? 'bg-gray-700' : 'bg-gray-100'} hover:opacity-80 transition-opacity`}
              aria-label="Toggle dark mode"
            >
              {settings.darkMode ? 
                <Sun className="w-5 h-5 text-yellow-400" /> : 
                <Moon className="w-5 h-5 text-gray-600" />
              }
            </button>
            
            <button
              onClick={() => setSidebarOpen(!sidebarOpen)}
              className={`p-2 rounded-lg ${settings.darkMode ? 'bg-gray-700' : 'bg-gray-100'} hover:opacity-80 transition-opacity lg:hidden`}
              aria-label="Toggle menu"
            >
              <Menu className={`w-5 h-5 ${textClass}`} />
            </button>
          </div>
        </div>

        {/* Desktop Navigation */}
        <div className="hidden lg:flex items-center gap-2 px-4 pb-4 flex-wrap">
          {navItems.map(({ id, label, icon: Icon }) => (
            <button
              key={id}
              onClick={() => setCurrentView(id)}
              className={`px-4 py-2 rounded-lg flex items-center gap-2 transition-colors ${
                currentView === id 
                  ? 'bg-blue-500 text-white' 
                  : `${settings.darkMode ? 'bg-gray-700 text-gray-300 hover:bg-gray-600' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`
              }`}
            >
              <Icon className="w-4 h-4" />
              {label}
            </button>
          ))}
        </div>
      </div>

      {/* Sidebar Overlay for Mobile */}
      {sidebarOpen && (
        <div 
          className="fixed inset-0 bg-black bg-opacity-50 z-40 lg:hidden"
          onClick={() => setSidebarOpen(false)}
        />
      )}

      {/* Sidebar */}
      <div className={`
        fixed top-0 left-0 h-full w-64 ${cardClass} border-r ${borderClass} z-50 transform transition-transform duration-300 ease-in-out shadow-xl
        ${sidebarOpen ? 'translate-x-0' : '-translate-x-full'}
        lg:hidden
      `}>
        <div className={`p-4 border-b ${borderClass} flex items-center justify-between`}>
          <h2 className={`text-lg font-semibold ${textClass}`}>Menu</h2>
          <button
            onClick={() => setSidebarOpen(false)}
            className={`p-2 rounded-lg ${settings.darkMode ? 'hover:bg-gray-700' : 'hover:bg-gray-100'} transition-colors`}
            aria-label="Close menu"
          >
            <X className={`w-5 h-5 ${textClass}`} />
          </button>
        </div>
        
        <nav className="p-4 space-y-2">
          {navItems.map(({ id, label, icon: Icon }) => (
            <button
              key={id}
              onClick={() => {
                setCurrentView(id);
                setSidebarOpen(false);
              }}
              className={`w-full px-4 py-3 rounded-lg flex items-center gap-3 transition-colors ${
                currentView === id 
                  ? 'bg-blue-500 text-white' 
                  : `${settings.darkMode ? 'text-gray-300 hover:bg-gray-700' : 'text-gray-700 hover:bg-gray-100'}`
              }`}
            >
              <Icon className="w-5 h-5" />
              <span className="font-medium">{label}</span>
            </button>
          ))}
        </nav>
      </div>

      {/* Main Content */}
      <div className="max-w-5xl mx-auto p-4">
        {/* Error Message */}
        {error && (
          <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4">
            {error}
            <button onClick={loadRoutines} className="ml-4 underline hover:no-underline">Retry</button>
          </div>
        )}

        {/* Views */}
        {currentView === 'routines' && (
          <div className="space-y-4">
            <RoutineList 
              routines={routines} 
              setRoutines={setRoutines}
              onUpdateCheck={updateRoutineChecks}
              onDelete={deleteRoutine}
              settings={settings} 
            />
            
            {!showAddRoutine && (
              <button
                onClick={() => setShowAddRoutine(true)}
                className={`w-full py-4 border-2 border-dashed rounded-lg flex items-center justify-center gap-2 transition-colors ${
                  settings.darkMode 
                    ? 'border-gray-600 text-gray-400 hover:border-blue-500 hover:text-blue-500' 
                    : 'border-gray-300 text-gray-500 hover:border-blue-500 hover:text-blue-500'
                }`}
              >
                <Plus className="w-5 h-5" />
                Add New Routine
              </button>
            )}

            {showAddRoutine && (
              <AddRoutineForm 
                onAdd={addRoutine} 
                onCancel={() => setShowAddRoutine(false)}
                settings={settings}
              />
            )}
          </div>
        )}

        {currentView === 'history' && (
          <HistoryView routines={routines} settings={settings} />
        )}

        {currentView === 'reports' && (
          <ReportsView routines={routines} settings={settings} />
        )}

        {currentView === 'profile' && (
          <ProfileSettings 
            user={user} 
            onLogout={onLogout}
            settings={settings}
            setSettings={setSettings}
          />
        )}
      </div>
    </div>
  );
}



// components/AuthPage.jsx
import React, { useState } from 'react';

export default function AuthPage({ onLogin, onSignup, settings }) {
  const [isLogin, setIsLogin] = useState(true);
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');

  const handleSubmit = (e) => {
    e.preventDefault();
    if (isLogin) {
      onLogin(email, password);
    } else {
      onSignup(email, password);
    }
  };

  const bgClass = settings.darkMode ? 'bg-gray-900' : 'bg-gradient-to-br from-blue-50 to-indigo-100';
  const cardClass = settings.darkMode ? 'bg-gray-800' : 'bg-white';
  const textClass = settings.darkMode ? 'text-white' : 'text-gray-900';
  const textSecondary = settings.darkMode ? 'text-gray-400' : 'text-gray-600';

  return (
    <div className={`min-h-screen ${bgClass} flex items-center justify-center p-4`} style={{ fontFamily: settings.fontFamily }}>
      <div className={`${cardClass} rounded-2xl shadow-xl p-8 w-full max-w-md`}>
        <div className="text-center mb-8">
          <div className="inline-flex items-center justify-center w-42 h-42 mb-4">
            <img 
              src="./logo.png" 
              alt="Blurz17 Logo" 
              className="w-full h-full"
            />
          </div>
          <h1 className={`text-3xl font-bold ${textClass}`}>Blurz17</h1>
          <p className={textSecondary}>Track your daily habits and goals</p>
        </div>

        <div className="flex gap-2 mb-6">
          <button
            onClick={() => setIsLogin(true)}
            className={`flex-1 py-2 rounded-lg font-medium transition-colors ${
              isLogin ? 'bg-blue-500 text-white' : `${settings.darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-700'}`
            }`}
          >
            Sign In
          </button>
          <button
            onClick={() => setIsLogin(false)}
            className={`flex-1 py-2 rounded-lg font-medium transition-colors ${
              !isLogin ? 'bg-blue-500 text-white' : `${settings.darkMode ? 'bg-gray-700 text-gray-300' : 'bg-gray-100 text-gray-700'}`
            }`}
          >
            Sign Up
          </button>
        </div>

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className={`block text-sm font-medium mb-2 ${textClass}`}>Email</label>
            <input
              type="email"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className={`w-full px-4 py-3 rounded-lg ${settings.darkMode ? 'bg-gray-700 text-white' : 'bg-gray-50 text-gray-900'} border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all`}
              placeholder="you@example.com"
              required
            />
          </div>

          <div>
            <label className={`block text-sm font-medium mb-2 ${textClass}`}>Password</label>
            <input
              type="password"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className={`w-full px-4 py-3 rounded-lg ${settings.darkMode ? 'bg-gray-700 text-white' : 'bg-gray-50 text-gray-900'} border border-gray-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all`}
              placeholder="••••••••"
              required
            />
          </div>

          <button
            type="submit"
            className="w-full bg-blue-500 text-white py-3 rounded-lg font-medium hover:bg-blue-600 transition-colors"
          >
            {isLogin ? 'Sign In' : 'Create Account'}
          </button>
        </form>
      </div>
    </div>
  );
}



my blurz book client side ::


structure project::
─ client
│  ├─ .env
│  ├─ index.html
│  ├─ next-env.d.ts
│  ├─ package-lock.json
│  ├─ package.json
│  ├─ postcss.config.js
│  ├─ public
│  │  ├─ Speaker.png
│  │  └─ vite.svg
│  ├─ README.md
│  ├─ src
│  │  ├─ App.jsx
│  │  ├─ components
│  │  │  ├─ BookCard.jsx
│  │  │  ├─ Header.jsx
│  │  │  └─ ProtectedRoute.jsx
│  │  ├─ context
│  │  │  └─ AuthContext.jsx
│  │  ├─ index.css
│  │  ├─ main.jsx
│  │  ├─ pages
│  │  │  ├─ AddBookPage.jsx
│  │  │  ├─ BookDetailPage.jsx
│  │  │  ├─ BooksPage.jsx
│  │  │  ├─ HomePage.jsx
│  │  │  ├─ LoginPage.jsx
│  │  │  ├─ MyBooksPage.jsx
│  │  │  └─ SignupPage.jsx
│  │  ├─ services
│  │  │  └─ api.js
│  │  └─ vite-env.d.ts
│  ├─ tailwind.config.js
│  ├─ tsconfig.json
│  ├─ tsconfig.node.json
│  └─ vite.config.ts



import React from 'react';
import { useNavigate } from 'react-router-dom';
import { Star } from 'lucide-react';

const BookCard = ({ book }) => {
  const navigate = useNavigate();
  const avgRating = book.reviews?.length > 0
    ? (book.reviews.reduce((sum, r) => sum + r.rating, 0) / book.reviews.length).toFixed(1)
    : 'N/A';

  return (
    <div className="bg-white rounded-xl shadow-lg hover:shadow-2xl transition p-6 cursor-pointer" onClick={() => navigate(`/book/${book.id}`)}>
      <h3 className="text-xl font-bold text-gray-800 mb-2">{book.title}</h3>
      <p className="text-gray-600 mb-1">by {book.author}</p>
      <p className="text-sm text-gray-500 mb-2">{book.category}</p>
      <p className="text-sm text-gray-700 mb-4 line-clamp-2">{book.description}</p>
      
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-1">
          <Star className="w-5 h-5 text-yellow-500 fill-yellow-500" />
          <span className="font-semibold">{avgRating}</span>
          <span className="text-gray-500 text-sm">({book.reviews?.length || 0})</span>
        </div>
        <span className="text-sm text-gray-500">{book.page_count} pages</span>
      </div>
    </div>
  );
};

export default BookCard;




import React, { useState } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { toast } from 'react-toastify';
import { Book, User, LogOut, Home, PlusCircle, Menu, X } from 'lucide-react';
import { useAuth } from '../context/AuthContext';

const Header = () => {
  const { logout } = useAuth();
  const navigate = useNavigate();
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

  const handleLogout = async () => {
    await logout();
    navigate('/login');
    toast.success('Logged out successfully');
  };

  return (
    <header className="bg-gradient-to-r from-blue-600 to-purple-600 text-white shadow-lg">
      <div className="container mx-auto px-4 py-4">
        <div className="flex justify-between items-center">
          <Link to="/" className="flex items-center space-x-2">
            <img src="/logo.svg" alt="Logo" className="h-8 w-8" onError={(e) => e.target.style.display = 'none'} />
            <span className="text-2xl font-bold">Blurz Books</span>
          </Link>

          <nav className="hidden md:flex items-center space-x-6">
            <Link to="/" className="hover:text-blue-200 transition flex items-center gap-2">
              <Home size={18} /> Home
            </Link>
            <Link to="/books" className="hover:text-blue-200 transition flex items-center gap-2">
              <Book size={18} /> Books
            </Link>
            <Link to="/my-books" className="hover:text-blue-200 transition flex items-center gap-2">
              <User size={18} /> My Books
            </Link>
            <Link to="/add-book" className="hover:text-blue-200 transition flex items-center gap-2">
              <PlusCircle size={18} /> Add Book
            </Link>
            <button onClick={handleLogout} className="bg-red-500 hover:bg-red-600 px-4 py-2 rounded-lg transition flex items-center gap-2">
              <LogOut size={18} /> Logout
            </button>
          </nav>

          <button onClick={() => setMobileMenuOpen(!mobileMenuOpen)} className="md:hidden">
            {mobileMenuOpen ? <X size={24} /> : <Menu size={24} />}
          </button>
        </div>

        {mobileMenuOpen && (
          <nav className="md:hidden mt-4 space-y-2">
            <Link to="/" className="block py-2 hover:bg-blue-700 px-2 rounded" onClick={() => setMobileMenuOpen(false)}>Home</Link>
            <Link to="/books" className="block py-2 hover:bg-blue-700 px-2 rounded" onClick={() => setMobileMenuOpen(false)}>Books</Link>
            <Link to="/my-books" className="block py-2 hover:bg-blue-700 px-2 rounded" onClick={() => setMobileMenuOpen(false)}>My Books</Link>
            <Link to="/add-book" className="block py-2 hover:bg-blue-700 px-2 rounded" onClick={() => setMobileMenuOpen(false)}>Add Book</Link>
            <button onClick={() => { handleLogout(); setMobileMenuOpen(false); }} className="w-full text-left py-2 hover:bg-red-700 px-2 rounded">Logout</button>
          </nav>
        )}
      </div>
    </header>
  );
};
export default Header;






import React from 'react';
import { Navigate } from 'react-router-dom';
import { useAuth } from '../context/AuthContext';

const ProtectedRoute = ({ children }) => {
  const { user, loading } = useAuth();
  
  if (loading) {
    return <div className="flex items-center justify-center h-screen">Loading...</div>;
  }
  
  return user ? children : <Navigate to="/login" />;
};

export default ProtectedRoute;



// client/src/pages/AddBookPage.jsx - FIXED VERSION

import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { toast } from 'react-toastify';
import api from '../services/api';
import Header from '../components/Header';

const AddBookPage = () => {
  const navigate = useNavigate();
  const [loading, setLoading] = useState(false);
  const [formData, setFormData] = useState({
    title: '',
    author: '',
    publisher: '',
    published_date: '',
    page_count: '',
    category: '',
    description: '',
    language: '',
  });

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    
    try {
      // FIX: Properly format the date without timezone issues
      const publishedDate = formData.published_date 
        ? `${formData.published_date}T00:00:00` // Add time component
        : new Date().toISOString();

      const bookData = {
        title: formData.title,
        author: formData.author,
        publisher: formData.publisher,
        published_date: publishedDate,
        page_count: parseInt(formData.page_count),
        category: formData.category,
        description: formData.description,
        language: formData.language,
      };

      console.log('Sending book data:', bookData); // Debug log

      await api.post('/book/create_book', bookData);
      toast.success('Book added successfully!');
      navigate('/my-books');
    } catch (error) {
      console.error('Error details:', error.response?.data); // Debug log
      
      if (error.response?.status === 403) {
        const detail = error.response?.data?.detail || '';
        
        if (detail.includes('verified') || detail.includes('verification')) {
          toast.error('Please verify your email before adding books. Check your inbox!');
        } else if (detail.includes('permission')) {
          toast.error('You don\'t have permission to add books.');
        } else {
          toast.error('Access denied: ' + detail);
        }
      } else {
        toast.error(error.response?.data?.detail || 'Failed to add book');
      }
    } finally {
      setLoading(false);
    }
  };

  return (
    <div>
      <Header />
      <div className="container mx-auto px-4 py-8 max-w-2xl">
        <h1 className="text-4xl font-bold text-gray-800 mb-8">Add New Book</h1>

        <form onSubmit={handleSubmit} className="bg-white rounded-xl shadow-lg p-8 space-y-6">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Title *</label>
            <input
              type="text"
              required
              value={formData.title}
              onChange={(e) => setFormData({ ...formData, title: e.target.value })}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
            />
          </div>

          <div className="grid md:grid-cols-2 gap-6">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Author *</label>
              <input
                type="text"
                required
                value={formData.author}
                onChange={(e) => setFormData({ ...formData, author: e.target.value })}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Publisher *</label>
              <input
                type="text"
                required
                value={formData.publisher}
                onChange={(e) => setFormData({ ...formData, publisher: e.target.value })}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
              />
            </div>
          </div>

          <div className="grid md:grid-cols-2 gap-6">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Category *</label>
              <input
                type="text"
                required
                value={formData.category}
                onChange={(e) => setFormData({ ...formData, category: e.target.value })}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Language *</label>
              <input
                type="text"
                required
                value={formData.language}
                onChange={(e) => setFormData({ ...formData, language: e.target.value })}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
              />
            </div>
          </div>

          <div className="grid md:grid-cols-2 gap-6">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Page Count *</label>
              <input
                type="number"
                required
                min="1"
                max="10000"
                value={formData.page_count}
                onChange={(e) => setFormData({ ...formData, page_count: e.target.value })}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Published Date *</label>
              <input
                type="date"
                required
                max={new Date().toISOString().split('T')[0]} // Prevent future dates
                value={formData.published_date}
                onChange={(e) => setFormData({ ...formData, published_date: e.target.value })}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
              />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Description *</label>
            <textarea
              required
              rows="4"
              value={formData.description}
              onChange={(e) => setFormData({ ...formData, description: e.target.value })}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
            />
          </div>

          <button
            type="submit"
            disabled={loading}
            className="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 transition disabled:opacity-50"
          >
            {loading ? 'Adding Book...' : 'Add Book'}
          </button>
        </form>
      </div>
    </div>
  );
};

export default AddBookPage;




const BookDetailPage = () => {
  const location = useLocation();
  const navigate = useNavigate();
  const pathParts = location.pathname.split('/');
  const id = pathParts[pathParts.length - 1];
  
  const [book, setBook] = useState(null);
  const [loading, setLoading] = useState(true);
  const [reviewData, setReviewData] = useState({ rating: 5, comment: '' });

  useEffect(() => {
    if (id) {
      fetchBook();
    }
  }, [id]);

  const fetchBook = async () => {
    try {
      const response = await api.get(`/book/${id}`);
      setBook(response.data);
    } catch (error) {
      toast.error('Failed to fetch book details');
      navigate('/books');
    } finally {
      setLoading(false);
    }
  };

  const handleAddReview = async (e) => {
    e.preventDefault();
    try {
      await api.post(`/reviews/add_review/${id}`, {
        rating: parseInt(reviewData.rating),
        comment: reviewData.comment,
      });
      toast.success('Review added successfully!');
      setReviewData({ rating: 5, comment: '' });
      fetchBook();
    } catch (error) {
      toast.error('Failed to add review');
    }
  };

  if (loading) {
    return (
      <div>
        <Header />
        <div className="text-center py-12">Loading book details...</div>
      </div>
    );
  }

  if (!book) return null;

  const avgRating = book.reviews?.length > 0
    ? (book.reviews.reduce((sum, r) => sum + r.rating, 0) / book.reviews.length).toFixed(1)
    : 'N/A';

  return (
    <div>
      <Header />
      <div className="container mx-auto px-4 py-8 max-w-4xl">
        <div className="bg-white rounded-xl shadow-lg p-8 mb-8">
          <h1 className="text-4xl font-bold text-gray-800 mb-4">{book.title}</h1>
          <p className="text-xl text-gray-600 mb-2">by {book.author}</p>
          <p className="text-gray-500 mb-4">{book.publisher} • {book.language}</p>
          
          <div className="flex items-center gap-4 mb-6 flex-wrap">
            <div className="flex items-center gap-1">
              <Star className="w-6 h-6 text-yellow-500 fill-yellow-500" />
              <span className="text-2xl font-semibold">{avgRating}</span>
              <span className="text-gray-500">({book.reviews?.length || 0} reviews)</span>
            </div>
            <span className="text-gray-600">{book.page_count} pages</span>
            <span className="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-sm">{book.category}</span>
          </div>

          <p className="text-gray-700 leading-relaxed">{book.description}</p>
        </div>

        <div className="bg-white rounded-xl shadow-lg p-8 mb-8">
          <h2 className="text-2xl font-bold text-gray-800 mb-4">Add a Review</h2>
          <form onSubmit={handleAddReview} className="space-y-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Rating</label>
              <select
                value={reviewData.rating}
                onChange={(e) => setReviewData({ ...reviewData, rating: e.target.value })}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
              >
                {[1, 2, 3, 4, 5].map(num => (
                  <option key={num} value={num}>{num} Star{num > 1 ? 's' : ''}</option>
                ))}
              </select>
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-2">Comment</label>
              <textarea
                required
                maxLength={80}
                value={reviewData.comment}
                onChange={(e) => setReviewData({ ...reviewData, comment: e.target.value })}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                rows="3"
                placeholder="Share your thoughts about this book..."
              />
              <p className="text-sm text-gray-500 mt-1">{reviewData.comment.length}/80 characters</p>
            </div>

            <button
              type="submit"
              className="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-2 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 transition"
            >
              Submit Review
            </button>
          </form>
        </div>

        <div className="bg-white rounded-xl shadow-lg p-8">
          <h2 className="text-2xl font-bold text-gray-800 mb-6">Reviews</h2>
          {book.reviews?.length === 0 ? (
            <p className="text-gray-500">No reviews yet. Be the first to review!</p>
          ) : (
            <div className="space-y-4">
              {book.reviews?.map((review) => (
                <div key={review.id} className="border-b border-gray-200 pb-4 last:border-0">
                  <div className="flex items-center gap-2 mb-2">
                    <div className="flex">
                      {[...Array(5)].map((_, i) => (
                        <Star
                          key={i}
                          className={`w-4 h-4 ${i < review.rating ? 'text-yellow-500 fill-yellow-500' : 'text-gray-300'}`}
                        />
                      ))}
                    </div>
                    <span className="text-sm text-gray-500">
                      {new Date(review.created_at).toLocaleDateString()}
                    </span>
                  </div>
                  <p className="text-gray-700">{review.comment}</p>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    </div>
  );
};
export default BookDetailPage;



import React, { useState, useEffect } from 'react';
import { toast } from 'react-toastify';
import api from '../services/api';
import Header from '../components/Header';
import BookCard from '../components/BookCard';

const BooksPage = () => {
  const [books, setBooks] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchBooks();
  }, []);

  const fetchBooks = async () => {
    try {
      const response = await api.get('/book/');
      setBooks(response.data);
    } catch (error) {
      toast.error('Failed to fetch books');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div>
      <Header />
      <div className="container mx-auto px-4 py-8">
        <h1 className="text-4xl font-bold text-gray-800 mb-8">All Books</h1>

        {loading ? (
          <div className="text-center py-12">Loading books...</div>
        ) : (
          <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            {books.map((book) => (
              <BookCard key={book.id} book={book} />
            ))}
          </div>
        )}
      </div>
    </div>
  );
};

export default BooksPage;


import React from 'react';
import { Link } from 'react-router-dom';
import { Book, User, PlusCircle } from 'lucide-react';
import { useAuth } from '../context/AuthContext';
import Header from '../components/Header';

const HomePage = () => {
  const { user } = useAuth();

  return (
    <div>
      <Header />
      <div className="container mx-auto px-4 py-12">
        <div className="text-center mb-12">
          <h1 className="text-5xl font-bold text-gray-800 mb-4">
            Welcome to Blurz Books, {user?.username}!
          </h1>
          <p className="text-xl text-gray-600">
            Manage your book collection with ease
          </p>
        </div>

        <div className="grid md:grid-cols-3 gap-8 max-w-5xl mx-auto">
          <Link to="/books" className="bg-white rounded-xl shadow-lg p-8 hover:shadow-2xl transition transform hover:-translate-y-2">
            <Book className="w-16 h-16 text-blue-600 mx-auto mb-4" />
            <h3 className="text-2xl font-bold text-gray-800 mb-2">Browse Books</h3>
            <p className="text-gray-600">Explore our collection of books</p>
          </Link>

          <Link to="/my-books" className="bg-white rounded-xl shadow-lg p-8 hover:shadow-2xl transition transform hover:-translate-y-2">
            <User className="w-16 h-16 text-purple-600 mx-auto mb-4" />
            <h3 className="text-2xl font-bold text-gray-800 mb-2">My Books</h3>
            <p className="text-gray-600">View your personal collection</p>
          </Link>

          <Link to="/add-book" className="bg-white rounded-xl shadow-lg p-8 hover:shadow-2xl transition transform hover:-translate-y-2">
            <PlusCircle className="w-16 h-16 text-green-600 mx-auto mb-4" />
            <h3 className="text-2xl font-bold text-gray-800 mb-2">Add Book</h3>
            <p className="text-gray-600">Add a new book to your collection</p>
          </Link>
        </div>
      </div>
    </div>
  );
};

export default HomePage;




import React, { useState, useEffect } from 'react';
import { Link } from 'react-router-dom';
import { toast } from 'react-toastify';
import { useAuth } from '../context/AuthContext';
import api from '../services/api';
import Header from '../components/Header';
import BookCard from '../components/BookCard';

const MyBooksPage = () => {
  const { user } = useAuth();
  const [books, setBooks] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (user?.user_id) {
      fetchMyBooks();
    }
  }, [user]);

  const fetchMyBooks = async () => {
    try {
      const response = await api.get(`/book/user/${user.user_id}`);
      setBooks(response.data);
    } catch (error) {
      toast.error('Failed to fetch your books');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div>
      <Header />
      <div className="container mx-auto px-4 py-8">
        <h1 className="text-4xl font-bold text-gray-800 mb-8">My Books</h1>

        {loading ? (
          <div className="text-center py-12">Loading your books...</div>
        ) : books.length === 0 ? (
          <div className="text-center py-12">
            <p className="text-gray-600 mb-4">You haven't added any books yet.</p>
            <Link to="/add-book" className="text-blue-600 hover:text-blue-700 font-semibold">
              Add your first book
            </Link>
          </div>
        ) : (
          <div className="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
            {books.map((book) => (
              <BookCard key={book.id} book={book} />
            ))}
          </div>
        )}
      </div>
    </div>
  );
};

export default MyBooksPage;


import React, { useState } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { toast } from 'react-toastify';
import { useAuth } from '../context/AuthContext';
import api from '../services/api';

const LoginPage = () => {
  const [formData, setFormData] = useState({ email: '', password: '' });
  const [loading, setLoading] = useState(false);
  const { login } = useAuth();
  const navigate = useNavigate();

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    try {
      const response = await api.post('/auth/login', formData);
      const { acess_token, refresh_token, email, username, user_id } = response.data;
      login({ email, username, user_id }, { acess_token, refresh_token });
      toast.success('Login successful!');
      navigate('/');
    } catch (error) {
      toast.error(error.response?.data?.detail || 'Login failed');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
        <div className="text-center mb-8">
          <img src="/logo.svg" alt="Logo" className="h-16 w-16 mx-auto mb-4" onError={(e) => e.target.style.display = 'none'} />
          <h1 className="text-3xl font-bold text-gray-800">Welcome Back</h1>
          <p className="text-gray-600 mt-2">Sign in to your account</p>
        </div>

        <form onSubmit={handleSubmit} className="space-y-6">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Email</label>
            <input
              type="email"
              required
              value={formData.email}
              onChange={(e) => setFormData({ ...formData, email: e.target.value })}
              className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
              placeholder="your@email.com"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-2">Password</label>
            <input
              type="password"
              required
              value={formData.password}
              onChange={(e) => setFormData({ ...formData, password: e.target.value })}
              className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
              placeholder="••••••••"
            />
          </div>

          <button
            type="submit"
            disabled={loading}
            className="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 transition disabled:opacity-50"
          >
            {loading ? 'Signing in...' : 'Sign In'}
          </button>
        </form>

        <p className="text-center mt-6 text-gray-600">
          Don't have an account?{' '}
          <Link to="/signup" className="text-blue-600 hover:text-blue-700 font-semibold">
            Sign Up
          </Link>
        </p>
      </div>
    </div>
  );
};

export default LoginPage;

import React, { useState } from 'react';
import { Link, useNavigate } from 'react-router-dom';
import { toast } from 'react-toastify';
import api from '../services/api';

const SignupPage = () => {
  const [formData, setFormData] = useState({
    username: '',
    email: '',
    first_name: '',
    last_name: '',
    password: '',
  });
  const [loading, setLoading] = useState(false);
  const navigate = useNavigate();

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    try {
      await api.post('/auth/signup', formData);
      toast.success('Account created! Please check your email to verify.');
      navigate('/login');
    } catch (error) {
      toast.error(error.response?.data?.detail || 'Signup failed');
    } finally {
      setLoading(false);
    }
  };

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-purple-50 flex items-center justify-center p-4">
      <div className="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
        <div className="text-center mb-8">
          <h1 className="text-3xl font-bold text-gray-800">Create Account</h1>
          <p className="text-gray-600 mt-2">Join Blurz Books today</p>
        </div>

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Username</label>
            <input
              type="text"
              required
              value={formData.username}
              onChange={(e) => setFormData({ ...formData, username: e.target.value })}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Email</label>
            <input
              type="email"
              required
              value={formData.email}
              onChange={(e) => setFormData({ ...formData, email: e.target.value })}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
            />
          </div>

          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">First Name</label>
              <input
                type="text"
                required
                value={formData.first_name}
                onChange={(e) => setFormData({ ...formData, first_name: e.target.value })}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
              />
            </div>
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">Last Name</label>
              <input
                type="text"
                required
                value={formData.last_name}
                onChange={(e) => setFormData({ ...formData, last_name: e.target.value })}
                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
              />
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Password</label>
            <input
              type="password"
              required
              minLength={8}
              value={formData.password}
              onChange={(e) => setFormData({ ...formData, password: e.target.value })}
              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
            />
          </div>

          <button
            type="submit"
            disabled={loading}
            className="w-full bg-gradient-to-r from-blue-600 to-purple-600 text-white py-3 rounded-lg font-semibold hover:from-blue-700 hover:to-purple-700 transition disabled:opacity-50"
          >
            {loading ? 'Creating Account...' : 'Sign Up'}
          </button>
        </form>

        <p className="text-center mt-6 text-gray-600">
          Already have an account?{' '}
          <Link to="/login" className="text-blue-600 hover:text-blue-700 font-semibold">
            Sign In
          </Link>
        </p>
      </div>
    </div>
  );
};

export default SignupPage;



import React from 'react';
import { BrowserRouter as Router, Routes, Route } from 'react-router-dom';
import { ToastContainer } from 'react-toastify';
import 'react-toastify/dist/ReactToastify.css';

// Import Context
import { AuthProvider } from './context/AuthContext';

// Import Components
import ProtectedRoute from './components/ProtectedRoute';

// Import Pages
import LoginPage from './pages/LoginPage';
import SignupPage from './pages/SignupPage';
import HomePage from './pages/HomePage';
import BooksPage from './pages/BooksPage';
import MyBooksPage from './pages/MyBooksPage';
import AddBookPage from './pages/AddBookPage';
import BookDetailPage from './pages/BookDetailPage';

const App = () => {
  return (
    <Router>
      <AuthProvider>
        <ToastContainer position="top-right" autoClose={3000} />
        <Routes>
          <Route path="/login" element={<LoginPage />} />
          <Route path="/signup" element={<SignupPage />} />
          <Route path="/" element={<ProtectedRoute><HomePage /></ProtectedRoute>} />
          <Route path="/books" element={<ProtectedRoute><BooksPage /></ProtectedRoute>} />
          <Route path="/my-books" element={<ProtectedRoute><MyBooksPage /></ProtectedRoute>} />
          <Route path="/add-book" element={<ProtectedRoute><AddBookPage /></ProtectedRoute>} />
          <Route path="/book/:id" element={<ProtectedRoute><BookDetailPage /></ProtectedRoute>} />
        </Routes>
      </AuthProvider>
    </Router>
  );
};

export default App;


backend structure::

book
├─ .env
├─ alembic.ini
├─ first lesson.txt
├─ main.py
├─ migrations
│  ├─ env.py
│  ├─ README
│  ├─ script.py.mako
├─ notes
│  └─ relational_DB.txt
├─ pip
├─ README.md
├─ run.bat
├─ src
│  ├─ auth
│  │  ├─ dependencies.py
│  │  ├─ routes.py
│  │  ├─ schema.py
│  │  ├─ service.py
│  │  ├─ utils.py
│  │  ├─ __init__.py
│  ├─ book
│  │  ├─ books_db.py
│  │  ├─ routes.py
│  │  ├─ schema.py
│  │  ├─ service.py
│  ├─ db
│  │  ├─ config.py
│  │  ├─ main.py
│  │  ├─ models.py
│  │  ├─ redis.py
│  │  ├─ __init__.py
│  ├─ err.py
│  ├─ errors.py
│  ├─ middleware.py
│  ├─ reviews
│  │  ├─ routes.py
│  │  ├─ schema.py
│  │  ├─ service.py
│  │  ├─ __init__.py
│  ├─ __init__.py





backend files ::::


main.py


from fastapi import FastAPI  ,status
from src.book.routes import book_router
from src.mailserver.routes import mail_router
from  fastapi.requests import Request
from src.auth.routes import auth_router
from contextlib import asynccontextmanager
from src.db.main import init_db
from src.reviews.routes import review_router
from src.errors import register_error_handlers
from src.err import creation_exceptions
from fastapi.responses import JSONResponse
from src.middleware import custome_simple_middle

@asynccontextmanager # this IS A dicorator act like class function that excute a fuctions before that happen and ecxute a function after an evernt
async def life_span(app:FastAPI):
#here the instructions that be run first when the server run

 print("the server has been started")
 # this is a async
 await init_db()
 
 yield #this word seperate that when the server start before it will run first ,
 #after it run when the server will be stoppped the instruction excute
 print("the server has been stopped")

version = "v1"

app = FastAPI(version=version,title="Blurz Book service",
              description="a high performance book web service",
              lifespan=life_span,
              redoc_url=f"/api/{version}/redocs",
              docs_url=f"/api/{version}/docs",
              contact={"email":"ffliuyh@gmail.com"},
                          
 ) 



"""this is exceptions registers """
creation_exceptions(app)


custome_simple_middle(app)


async def internal_server_error(e:Exception,r:Request):

            return JSONResponse(
                content={
                    
                    "message": "Oops! Something went wrong",
                    "error_code": "server_error",
                    'status_code':status.HTTP_500_INTERNAL_SERVER_ERROR,

                },
            )



app.add_exception_handler(500,internal_server_error)


app.include_router(book_router, prefix=f"/api/{version}/book",tags="book") 
app.include_router(auth_router, prefix=f"/api/{version}/auth",tags="auth") 
app.include_router(review_router, prefix=f"/api/{version}/reviews",tags="reviews") 
app.include_router(mail_router, prefix=f"/api/{version}/emails",tags="emails") 


"""Experimental endpoint to check the overriding of the exception will happen or not """

async def crash_by_division_zero ():
    return 4/0

app.add_api_route(path='/crash',
                 endpoint =  crash_by_division_zero,
                  methods=['GET']
                       )





DB_URL=postgresql+asyncpg://postgres:Ah123456789@localhost:5432/blurz_db
#  jwt confing
jwt_secret=e4da7262d3c5ee5db1385c4ff7890eb92e992dcc3fc95b340b29a7a342ee97e7
password_secrete_reset=TsyGlEv65bYI8kFt5fWh6dT2SzKXcxDSYKAccctzGQVJrQbZxFIloID1edKXh5uUdz8PmI5Apf5-Spx-Sf-P_Q
jwt_algorithm=HS256
refresh_token_expiary=7
access_token_expiary=30

# redis ciinfig 

ResisHost=localhost  
ResdisPort=6379
Redis_DB=0
Redis_Url=redis://localhost:6379/0

domain=http://127.0.0.1:8000/api/v1

#  Email Configrationa 


MAIL_USERNAME=ffkiuyh
MAIL_FROM=ffkiuyh@gamil.com
MAIL_PORT=587
MAIL_SERVER=smtp.gmail.com
MAIL_FROM_NAME=Blurz_Book
MAIL_STARTTLS=True
MAIL_SSL_TLS=False
USE_CREDENTIALS=True
VALIDATE_CERTS=True
TEMPLATE_FOLDER=Path(BASE_DIR, "templates")

MAIL_PASSWORD=mplvmbiriewksfhi



src\middleware.py




from fastapi import FastAPI,status
from fastapi.requests import Request
from fastapi.middleware.cors import CORSMiddleware
from fastapi.middleware.trustedhost import TrustedHostMiddleware
import time 
import logging

"""simple middleware type one"""


 #   the functions of the middleware are : logging request , authuntication like in the dependencies injection 
 # , cors origins and prevent host attack  , Rate lImiting , 
 
def custome_simple_middle(app:FastAPI):
    logging.disable = True
    
    @app.middleware('http')
    
    async def custome_logging(request:Request,call_next):
        
        start_time = time.time()
                
        logging = await call_next(request)
        
        prcessed_time = time.time() - start_time
         
         
        message = f"{request.client.host}:{request.client.port} - {request.method} - {request.url.path} -completed after {prcessed_time}s"
        
        print(message)
        
        return logging
    
    app.add_middleware(
    CORSMiddleware,
    allow_origins= ['127.0.0.0'] ,
    allow_methods=['GET','POST','PATCH','DELETE'],
    allow_headers=['*'],
    allow_credentials = True,
       
    )
    
    
    app.add_middleware(
        TrustedHostMiddleware ,
        allowed_hosts=["localhost", "127.0.0.1"],

    )
    
    
        
        





src\auth\routes.py
from fastapi import APIRouter, Depends, status, HTTPException
from src.db.main import get_session
from .service import User_Service
from .schema import Create_User as Create_User_Model, User,Login_User,UserInfo,Password_Reset,Password_reset_Confirm
from sqlmodel.ext.asyncio.session import AsyncSession
from sqlalchemy.exc import IntegrityError
from .utils import access_token,verify_password,CreationSafeLink,generate_hashed_password
from datetime import datetime,timedelta
from src.db.config import config
from fastapi.responses import JSONResponse
from .dependencies import RefreshToken,AccessTokenBearer,get_current_user,CheckRoler
from src.err import AccessTokenRequired,UserAlreadyExists,UserNotFound,InvalidCredentials,VerificationError,DataNotFound,PasswordAlreadyReset,UserAlreadyVerify
from src.db.redis import add_to_blacklist,check_blacklist
from src.mailserver.service import send_email,mail
from src.celery.celery_tasks import bg_send_mail
from src.db.models import User as User_DB


auth_router = APIRouter()

user_service = User_Service()
checkroler = Depends(CheckRoler(['admin','user']))

access_token_bearer = AccessTokenBearer()

password_reset_link = CreationSafeLink(config.password_secrete_reset,'password_reset_link')

email_verification_link = CreationSafeLink(config.jwt_secret,'email_verification_link')


refresh = timedelta(days=config.refresh_token_expiary)

access = timedelta(minutes=config.access_token_expiary)

@auth_router.post("/signup",
                  response_model=User,
                  status_code=status.HTTP_201_CREATED,
                  )
async def create_user(
    user_data: Create_User_Model, 
    session: AsyncSession = Depends(get_session)
):
    email = user_data.email
    is_existed = await user_service.user_exist(email, session)
    
    if is_existed:
        raise UserAlreadyExists()
    
    try:
        
        new_user = await user_service.create_user(user_data, session)
        token = email_verification_link.create_safe_url({"email":email})
      
        link = f'{config.domain}/auth/verify/{token}'
        
        data = {"link":link}
        
        send_email( rec=[email],
                            sub='verify email',
                            data_var=data,
                            html_path='verify_message.html')# the result is a message that sent to the user wiht link
      
      
        return new_user
    except IntegrityError:
        raise UserAlreadyExists()


@auth_router.post('/resend_verify_link')
async def crtate_url_vreification(email:Password_Reset,session: AsyncSession = Depends(get_session)):
    email = email.email
    if not email :
        raise DataNotFound()
    is_existed = await user_service.user_exist(email, session)
    
    if is_existed:
    
        token = email_verification_link.create_safe_url({"email":email})
      
        link = f'{config.domain}/auth/verify/{token}'
        
        data = {"link":link}
        
        bg_send_mail.delay(rec=[email],sub = 'verifyin mail',html_path='verify_message.html',data_var=data)
        
     



"""verify the URL to check is valid"""  
@auth_router.get("/verify/{token}")

async def activation_user(token:str,session:AsyncSession=Depends(get_session),accesstoken =Depends(AccessTokenBearer)):
    
    data = email_verification_link.de_serializ_url(token)
    
    if check_blacklist(data['token_id']):
        raise UserAlreadyVerify()
    
    email = data['email']
    if not email:
        raise VerificationError()
    
    await user_service.activation_user(email,session)
    
    await add_to_blacklist(accesstoken['jti'])

    await add_to_blacklist(data['token_id'],exp=1600)

    return JSONResponse(
            content={"message": "Account verified successfully"},
            status_code=status.HTTP_200_OK,
        )    



@auth_router.post('/login',)
async def login_user(user_data:Login_User,session:AsyncSession=Depends(get_session)):
    user_data_login = user_data
    email = user_data_login.email   # notice here we didn't access as a dictinary cause it still in the pydasntic model object not converted to json model 
    password = user_data_login.password 
    
    # check if the user exist or not 
    user_existence:User_DB= await user_service.get_user_by_email(email,session)
    
    if not user_existence:
        raise UserNotFound()
      
    is_valid_password = verify_password(password,user_existence.password_hash) 
     
    if is_valid_password:
        
         # here we create the tokne  for this user cause he prove is a correct one
        Acess_Token = access_token(
                            user_data={
                                "email":email,
                                "id":str(user_existence.id),
                                "username":user_existence.username,
                            },
                            expire=access
                        )
        refresh_token = access_token(
                            user_data={
                                "email":email,
                                "id":str(user_existence.id),
                                "username":user_existence.username,
                            },
                            expire=refresh,
                            refresh=True
                        )  
                        
                        
        return JSONResponse(
                        content ={ "message":"you have login successfully",
                                    "acess_token":Acess_Token,
                                    "refresh_token":refresh_token,
                                    "email":email,
                                    "username":user_existence.username,
                                    "user_id":str(user_existence.id)
            
                                    },
                                status_code= 200)
        
         

                      
    else:
        raise HTTPException(status_code=status.HTTP_403_FORBIDDEN
                            , detail="Invalid Credentials")


@auth_router.get('/me',response_model=UserInfo,
                    dependencies=[checkroler])

async def get_me(user_details:User=Depends(get_current_user)):
    return user_details

    
@auth_router.post('/refresh_token')
async def get_acces_by_refresh(token:dict=Depends(RefreshToken())):
    
    if token:
        new_access_token = access_token(user_data=token['user'],expire=access)
        
        return JSONResponse(
               content ={
                  "acess_token":new_access_token
             } )
    
    raise HTTPException(
        status_code=status.HTTP_403_FORBIDDEN,
                        detail='this token either expired or invalid')
     
    
@auth_router.post('/logout')
async def logout(token:dict=Depends(AccessTokenBearer())):
    
    if await add_to_blacklist(token['jti']):
        return JSONResponse(
            content={"Message":"you have loged out successflly"},
            status_code = 200,

        )
    else:
        print('there was an erro while revoking this token ')
    
    
    
    """
    
    notice this for forget Password reset flow , not regular reset password this in case the user forget the original password
    
    1: user request to resent his password 
    
    2: the token or the email exctracted from but be carfull , we check if exist or not then if exist 

    3: we shall send to this user mail an uniuque link that contain a token with period expiration and this email
        
    4: when the user click on this link and the link is valid the user can now reset the password and revoke the token of authorization 
    and add to the redis black list
    
    
    5: after the user has successfully updated the password the access ,refresh and link token must be revoked and added to the redis blacklist
    
    """ 
   # Notice this is for forgetting password and not in normal reset password 
@auth_router.post('/password_reset')
async def passsword_reset(Email:Password_Reset,session:AsyncSession=Depends(get_session),_=Depends(AccessTokenBearer())):
    email = Email.email
    
    user_existence = await user_service.get_user_by_email(email,session)
    
    if not user_existence:
        raise UserNotFound()
    
    try:
        
        token = password_reset_link.create_safe_url({"email":email})
      
        link = f'{config.domain}/auth/confirm_password/{token}'
        
        data = {"link":link}
        
        bg_send_mail.delay(rec=email,
                            data_var=data,html_path='password_reset_link.html',
                            sub = 'Reset Email Password')# the result is a message that sent to mail user wiht link
      
      
    except IntegrityError:
        raise UserAlreadyExists() 
    
@auth_router.post("/confirm_password/{token}")

async def confirm_password(passwords:Password_reset_Confirm
                           ,token:str,session:AsyncSession=Depends(get_session)
                           ,access_token:dict=Depends(AccessTokenBearer()),):
    
    data = password_reset_link.de_serializ_url(token,600)
    
    """check if this link is beeing sent again to prevent it from consuming resourse """
    if check_blacklist(data['token_id']):
        raise UserAlreadyVerify()
    

    if not passwords.new_password==passwords.confirm_password:
        raise InvalidCredentials()
    
    email = data['email']
    if not email:
        raise DataNotFound()
    try:
        user_exist =  await user_service.get_user_by_email(email,session)
        if not user_exist:
            raise UserNotFound()
    except IntegrityError:
        raise IntegrityError()
    new_password = generate_hashed_password(passwords.new_password)
    user_exist.password_hash = new_password
    await session.commit()
    await session.refresh(user_exist)
    
    """if the user arrive hr this mean the user has successfully verify so we should block this ulr beeing used again"""
    
    await add_to_blacklist(access_token['jti'])
    await add_to_blacklist(data['token_id'],exp=600)
   
    
    return JSONResponse(
            content={"message": "Password has been updated successfully"},
            status_code=status.HTTP_200_OK,
        )  


src\auth\schema.py
from pydantic import BaseModel, Field
import uuid
from datetime import datetime
from typing import  List
from src.book.schema import Book
from src.reviews.schema import Review
class User(BaseModel): 
    id: uuid.UUID 
    username: str = Field(max_length=20)
    email: str = Field(max_length=40)
    first_name: str
    last_name: str
    is_verifed: bool 
    created_at: datetime 
    updated_at: datetime



class UserInfo(User):
    books:List[Book]
    reviews:List[Review]

""""password mustn't given at the reponse model"""


class Create_User(BaseModel): 
    username: str = Field(max_length=20)
    email: str = Field(max_length=40)
    first_name: str
    last_name: str
    password: str = Field(min_length=8, max_length=72) 
    

class Update_User(BaseModel): 
    username: str = Field(max_length=20)
    first_name: str
    last_name: str
    is_verifed: bool 
    
    
class User_Activation(BaseModel): 
    is_verifed: bool 



    
class Login_User(BaseModel): 
    email: str = Field(max_length=40)
    password: str = Field(min_length=8, max_length=72) 
    
    
    
class Password_Reset(BaseModel):
    email:str
    
    
class Password_reset_Confirm(BaseModel):
    new_password:str=Field(min_length=8, max_length=72) 
    confirm_password:str=Field(min_length=8, max_length=72) 



src\book\routes.py


from fastapi import APIRouter, status, Depends
from fastapi.exceptions import HTTPException
from typing import List
from .schema import Book, UpdateBook, CreateBook,ReviewBook
from .service import BookService
from sqlmodel.ext.asyncio.session import AsyncSession
from src.db.main import get_session
from src.auth.dependencies import AccessTokenBearer,CheckRoler,get_current_user
from src.db.models import User

# objects definations 
book_router = APIRouter()
 
book_service = BookService()  

Bearer = AccessTokenBearer()

checkroler = Depends(CheckRoler(['admin','user']))


@book_router.get('/hello')  
async def hi():
    return {"message": "hello"}


@book_router.get('/', response_model=List[ReviewBook],dependencies=[checkroler])  
async def get_books(session: AsyncSession = Depends(get_session),
                    _:dict=Depends(Bearer)):
    
    
    books = await book_service.get_books(session)
    return books


@book_router.get('/{id}', response_model=ReviewBook,dependencies=[checkroler])  
async def get_a_book(id: str, 
                     session: AsyncSession = Depends(get_session)):
    get_book = await book_service.get_book(id, session)
    if not get_book:
        raise HTTPException(status_code=404, detail="Book not found")
    return get_book

"""get the user books only """
#  here we can get the user id from the get me route in the auth.routes we can excatract the id from the token

@book_router.get('/user/{user_id}', response_model=list[Book],dependencies=[checkroler])  
async def get_user_books(
                     user_id: str, 
                     session: AsyncSession = Depends(get_session)
                     ):
    
    get_book = await book_service.get_user_books(user_id, session)
    if not get_book:
        raise HTTPException(status_code=404, detail="Book not found")
    return get_book



@book_router.post('/create_book', status_code=status.HTTP_201_CREATED, response_model=Book,dependencies=[checkroler])  
async def create_book(data: CreateBook,
                      session: AsyncSession = Depends(get_session),
                      _:dict=Depends(Bearer),
                      user_data:User=Depends(get_current_user)): 

    user_id = user_data.id
    
    new_book = await book_service.create_book(data, user_id,session)
    return new_book





@book_router.patch('/update_book/{id}', response_model=Book,dependencies=[checkroler]) 
async def update_a_book(id: str
                        , data: UpdateBook
                        , session: AsyncSession = Depends(get_session)): 
    updated_book = await book_service.update_book(id, data, session)
    if not updated_book:
        raise HTTPException(status_code=404, detail="Book not found")
    return updated_book


@book_router.delete('/delete_book/{id}', status_code=status.HTTP_204_NO_CONTENT,dependencies=[checkroler])
async def delete_book(id: str,
                      session: AsyncSession = Depends(get_session)):
    deleted_book = await book_service.delete_book(id, session)
    if deleted_book is None:
        raise HTTPException(status_code=404, detail="Book not found")
    return None  # For 204 responses





src\book\schema.py


from pydantic import BaseModel 
import uuid
from datetime import datetime
from src.reviews.schema import Review
from typing import List
class Book(BaseModel): 
    id: uuid.UUID
    title: str
    author: str
    publisher: str
    page_count: int
    category: str
    description:str
    language: str
    published_date: datetime
    created_at: datetime
    updated_at: datetime


class CreateBook(BaseModel):  
    title: str
    author: str
    publisher: str
    published_date: datetime
    page_count: int
    category: str
    description:str
    language: str

  
class UpdateBook(BaseModel): 
    title: str
    author: str
    publisher: str
    published_date: datetime
    page_count: int
    category: str
    description:str
    language: str




class ReviewBook(Book):
    
   reviews:List[Review]


src\db\main.py

from sqlmodel import SQLModel
from sqlalchemy.ext.asyncio import create_async_engine  
from  .config import config
from sqlalchemy.orm import sessionmaker
from sqlmodel.ext.asyncio.session import AsyncSession 
engine = create_async_engine(
        config.DB_URL,
            )


async def init_db():
    async with engine.begin() as conn :
       await conn.run_sync(SQLModel.metadata.create_all)
       

async_session = sessionmaker(
    bind = engine ,
    class_=AsyncSession,
    expire_on_commit= False
)
   
       
async def get_session():
    async with async_session() as session:
        yield session




src\db\models.py

from sqlmodel import SQLModel ,Field,Column,Relationship
import uuid
from datetime import datetime
import sqlalchemy.dialects.postgresql as pg
from typing import List,TYPE_CHECKING,Optional



class User (SQLModel,table=True):
    __tablename__="User" 
    id: uuid.UUID = Field(
            sa_column=Column(
                pg.UUID,               primary_key=True,
                nullable=False,
                default = uuid.uuid4)
        )
    username:str
    email:str
    first_name:str
    last_name:str
    role:str= Field(sa_column=Column(
        pg.VARCHAR,
        nullable=False,
        server_default="user"
    ))
    
    
    books:List["Book"]=Relationship(
                         back_populates="user",
                                    sa_relationship_kwargs={'lazy':'selectin'})
    reviews:List["Review"]=Relationship(
                         back_populates="user",
                                    sa_relationship_kwargs={'lazy':'selectin'})
       
    password_hash:str=Field(exclude=True)
    is_verifed:bool=Field(default=False)
    created_at: datetime | None = Field(default_factory=datetime.now)
    updated_at: datetime | None = Field(default_factory=datetime.now)
    
    
    def __repr__(self):
        return f"User(username={self.username})"
    
    

class Book(SQLModel, table=True):
    __tablename__ = "Book"

    id: uuid.UUID = Field(
        sa_column=Column(
            pg.UUID, 
            primary_key=True,
            nullable=False,
            default = uuid.uuid4)
    )
    
    user_id:uuid.UUID | None = Field(default=None, foreign_key="User.id")
    title: str = Field(nullable=False)
    author: str | None = None
    description:str
    page_count: int | None = None
    category:str
    user:Optional['User'] = Relationship(
        back_populates="books"  
    )
    reviews:List["Review"]=Relationship(
                         back_populates="book",
                                    sa_relationship_kwargs={'lazy':'selectin'})
       
    publisher: str | None = None
    published_date: datetime | None = Field(default_factory=datetime.now)
    language: str | None = None
    created_at: datetime | None = Field(default_factory=datetime.now)
    updated_at: datetime | None = Field(default_factory=datetime.now)

    def __repr__(self):
        return f"Book(title={self.title})"
   
   
   
class Review(SQLModel, table=True):
    __tablename__ = "Review"

    id: uuid.UUID = Field(
        sa_column=Column(
            pg.UUID, 
            primary_key=True,
            nullable=False,
            default = uuid.uuid4)
    )
    
    rating:int=Field(
        le=5,
    )
    
    comment:str=Field(max_length=80)
    user_id:uuid.UUID | None = Field(default=None, foreign_key="User.id")
    book_id:uuid.UUID | None = Field(default=None, foreign_key="Book.id")
    created_at:datetime | None=Field(default_factory=datetime.now)
    updated_at: datetime | None = Field(default_factory=datetime.now)
    
    user:Optional['User'] = Relationship(
        back_populates="reviews"  
    )
    
    book:Optional['Book'] = Relationship(
        back_populates="reviews"  
    )
    
    
    def __repr__(self):
        return f"This review {self.book_id} is made by this user:{self.user_id}"
   
   
   


src\mailserver\routes.py

from fastapi import APIRouter
from .schema import Mail_send_Mode
from .service import welcome_message,mail
mail_router = APIRouter()

@mail_router.post('/welcome')
async def sending_mail(mails:Mail_send_Mode):
    
  
    recepients = mails.emails
    message =await welcome_message(recepients=recepients)
    
    await mail.send_message(message)
    return {'message':'Email has been sent'}
    
    
src\mailserver\schema.py
from pydantic import BaseModel



class Mail_send_Mode(BaseModel):
    emails:list[str]
  


src\reviews\routes.py

from fastapi import APIRouter,Depends
from .service import Review_Service
from src.auth.dependencies import get_current_user,CheckRoler
from sqlmodel.ext.asyncio.session import AsyncSession
from .schema import CreateReview
from src.db.models import Review,User
from src.db.main import get_session
from src.book.schema import ReviewBook

review_router = APIRouter()

review_service = Review_Service()

checkroler = Depends(CheckRoler(['admin','user']))


@review_router.post('/add_review/{book_id}',response_model=Review,dependencies=[checkroler])
async def add_review(review_data:CreateReview,
                     book_id:str,
                     user_details:User=Depends(get_current_user),
                     session:AsyncSession=Depends(get_session)):
    
    
    user_email =user_details.email
    
    return await review_service.add_review(review_data,
                              book_id,
                              user_email,
                              session)





from typing import Any
from fastapi.requests import Request
from fastapi.responses import JSONResponse
from fastapi import FastAPI, status


class AppError(Exception):
    """Base class for all application errors"""
    pass


class InvalidToken(AppError):
    """Token is invalid or corrupted"""
    pass


class TokenExpired(AppError):
    """Token has expired"""
    pass


class RevokedToken(AppError):
    """Token has been revoked"""
    pass


class AccessTokenRequired(AppError):
    """Access token is required but not provided"""
    pass


class RefreshTokenRequired(AppError):
    """Refresh token is required but not provided"""
    pass


class UserAlreadyExists(AppError):
    """User with this email already exists"""
    pass


class InvalidCredentials(AppError):
    """Invalid email or password"""
    pass


class InsufficientPermission(AppError):
    """User lacks necessary permissions"""
    pass


class BookNotFound(AppError):
    """Book not found"""
    pass


class TagNotFound(AppError):
    """Tag not found"""
    pass


class TagAlreadyExists(AppError):
    """Tag already exists"""
    pass


class UserNotFound(AppError):
    """User not found"""
    pass


class EmailNotVerified(AppError):
    """User email has not been verified"""
    pass


class VerificationError(AppError):
    """Error during email verification process"""
    pass
class UserAlreadyVerify(AppError):
    """Error during email verification process"""
    pass

class DataNotFound(AppError):
    pass

class PasswordAlreadyReset(AppError):
    pass
class PasswordNotMatced(AppError):
    pass


# Exception registry with proper error codes and messages
register_exception = {
    InvalidToken: {
        "status_code": status.HTTP_401_UNAUTHORIZED,
        "initial_detail": {
            "message": "The provided token is invalid or corrupted",
            "error_code": "invalid_token",
        }
    },
    
    TokenExpired: {
        "status_code": status.HTTP_401_UNAUTHORIZED,
        "initial_detail": {
            "message": "The verification link has expired. Please request a new one",
            "error_code": "token_expired",
        }
    },
    
    RevokedToken: {
        "status_code": status.HTTP_401_UNAUTHORIZED,
        "initial_detail": {
            "message": "This token has been revoked",
            "error_code": "token_revoked",
        }
    },
    
    AccessTokenRequired: {
        "status_code": status.HTTP_401_UNAUTHORIZED,
        "initial_detail": {
            "message": "Access token is required for this operation",
            "error_code": "access_token_required",
        }
    },
    
    RefreshTokenRequired: {
        "status_code": status.HTTP_401_UNAUTHORIZED,
        "initial_detail": {
            "message": "Refresh token is required for this operation",
            "error_code": "refresh_token_required",
        }
    },
    
    UserNotFound: {
        "status_code": status.HTTP_404_NOT_FOUND,
        "initial_detail": {
            "message": "User not found",
            "error_code": "user_not_found",
        }
    },
    
    UserAlreadyExists: {
        "status_code": status.HTTP_409_CONFLICT,
        "initial_detail": {
            "message": "A user with this email already exists",
            "error_code": "user_exists",
        }
    },
    
    InvalidCredentials: {
        "status_code": status.HTTP_401_UNAUTHORIZED,
        "initial_detail": {
            "message": "Invalid email or password",
            "error_code": "invalid_credentials",
        }
    },
    
    InsufficientPermission: {
        "status_code": status.HTTP_403_FORBIDDEN,
        "initial_detail": {
            "message": "You don't have permission to perform this action",
            "error_code": "insufficient_permission",
        }
    },
    
    EmailNotVerified: {
        "status_code": status.HTTP_403_FORBIDDEN,
        "initial_detail": {
            "message": "Please verify your email before logging in",
            "error_code": "email_not_verified",
        }
    },
    
    VerificationError: {
        "status_code": status.HTTP_403_FORBIDDEN,
        "initial_detail": {
            "message": "There was an error verifying your email",
            "error_code": "verification_error",
            'resoluttion':'verify your email first'
        }
    },
    
    BookNotFound: {
        "status_code": status.HTTP_404_NOT_FOUND,
        "initial_detail": {
            "message": "Book not found",
            "error_code": "book_not_found",
        }
    },
    
    TagNotFound: {
        "status_code": status.HTTP_404_NOT_FOUND,
        "initial_detail": {
            "message": "Tag not found",
            "error_code": "tag_not_found",
        }
    },
    
    TagAlreadyExists: {
        "status_code": status.HTTP_409_CONFLICT,
        "initial_detail": {
            "message": "A tag with this name already exists",
            "error_code": "tag_exists",
        }
    },
    
    UserAlreadyVerify: {
        "status_code": status.HTTP_400_BAD_REQUEST,
        "initial_detail": {
            "message": 'already verify ',
            "error_code": "Verified email",
        }
    },
    PasswordAlreadyReset: {
        "status_code": status.HTTP_400_BAD_REQUEST,
        "initial_detail": {
            "message": 'already reset with this URL ',
            "error_code": "password is reset and this link is expired  ",
        }
    },           
    PasswordNotMatced: {
        "status_code": status.HTTP_400_BAD_REQUEST,
        "initial_detail": {
            "message": 'passwords not matched  ',
            "error_code": "NOT MATCHED  ",

        }
    },
   
    DataNotFound: {
        "status_code": status.HTTP_400_BAD_REQUEST,
        "initial_detail": {
            "message": 'NO data provided  ',
            "error_code": "lackness of data ",
        }
    },
}


def registery(status_code: int, detail: Any):
    """Create exception handler with proper status code and detail"""
    async def error_handler(req: Request, exc: AppError):
        return JSONResponse(
            content={
                "status_code": status_code,
                "detail": detail
            },
            status_code=status_code
        )
    return error_handler


def creation_exceptions(app: FastAPI):
    """Register all exception handlers with the FastAPI app"""
    for excp, exc_info in register_exception.items():
        app.add_exception_handler(
            excp,
            registery(
                status_code=exc_info['status_code'],
                detail=exc_info['initial_detail']
            )
        )